name: Retrieve TSE list

on:
  schedule:
    - cron: '0 5 * * *'
  workflow_dispatch:

jobs:
  retrieve:
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv, imagick, fileinfo
        coverage: none

    - name: Cache Composer packages
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}

    - name: Create composer.json
      run: |
        echo '{
          "require": {
            "rechtlogisch/tse-id-php": "^0.1",
            "symfony/console": "^7.2",
            "symfony/browser-kit": "^7.2",
            "symfony/css-selector": "^7.2",
            "symfony/http-client": "^7.2"
          }
        }' > composer.json

    - name: Install package
      run: composer require rechtlogisch/tse-id-php --dev --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts

    - name: Run retrieve console command
      run: vendor/bin/console tse-id:retrieve list

    - name: Set current date
      run: echo "DATE_CURRENT=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

    - name: Check for differences
      id: diff
      shell: bash +e {0}
      run: |
        diff "list/${{ env.DATE_CURRENT }}.json" list/current.json
        EXIT_STATUS=$?
        if [ $EXIT_STATUS -eq 1 ]; then
          echo "differences=true" >> $GITHUB_OUTPUT
          echo "Differences found"
          exit 0
        elif [ $EXIT_STATUS -eq 0 ]; then
          echo "differences=false" >> $GITHUB_OUTPUT
          echo "No differences found"
          exit 0
        else
          echo "Unexpected error occured while running diff"
          exit $EXIT_STATUS
        fi

    - name: Update current.json
      if: steps.diff.outputs.differences == 'true'
      run: cp "list/${{ env.DATE_CURRENT }}.json" list/current.json

    - name: Create Pull Request
      if: steps.diff.outputs.differences == 'true'
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: Add changed list
        title: 'feat: TSE list changed on ${{ env.DATE_CURRENT }}'
        body: |
          Updates the list of available TSE.

          Auto-generated by the GitHub workflow [retrieve.yml](../actions/workflows/retrieve.yml)
        branch: update-tse-list
        delete-branch: true
        add-paths: |
          list/current.json
          list/${{ env.DATE_CURRENT }}.json
